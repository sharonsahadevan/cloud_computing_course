# Show Azure Networking Services

The goal: show Azure Networking Services

The demo involves two parts:

1. provision two vms with Postgres instances and access them via public and private interfaces
2. review networking services from AKS demo.

As provisioning VMs and Postgres takes a while, it's suggested to review AKS networking services while terraform takes care of infrastructure creation.

## VMs, Postgres, and everything in between

1. Login to azure `az login` and select Subscription `az account set -s $SUBSCRIPTION_ID`

2. Change working directory to: `cd src/terraform/05-core-services-networking`

3. Create `terraform.tfvars` file. This file will contain your unique properties for the rest of terraform configuration, for example:

```sh
cat > terraform.tfvars << EOF
subscription_id = "00000000-0000-0000-0000-000000000000"

prefix   = "igork"
location = "westeurope"

psql_admin    = "psqladmin"
psql_password = "Secure-password"
EOF
```

4. Review proposed terraform configuration:

  - create two VMs and two PSQL instances
  - one VM communicates with PSQL via public interface. VM public IP is added to PSQL firewall rules
  - the second VM uses PSQL private endpoint and all the traffic does not leave Azure data-center

5. Provision Azure components via terraform

```sh
terraform init
terraform apply
```

NOTE: deployment fails at first, because `azurerm_postgresql_firewall_rule` cannot get public_ip value. Azure assigns real IP address only when it is attached to a network-interface. However, terraform stores public_ip information in state file after the ip object is created and at this point of time the value is empty string `""`:
> Error: expected start_ip_address to contain a valid IPv4 address, got: 
>
>  with module.vm_psql_net.azurerm_postgresql_firewall_rule.psql_public_fw_rule,
>  on ../modules/vm_psql/public_psql.tf line 29, in resource "azurerm_postgresql_firewall_rule" "psql_public_fw_rule":
>  29:   start_ip_address    = azurerm_public_ip.vm_public_pip.ip_address

You can check empty value in state file, then rerun `terraform apply`, then check the state file again.

6. Parse terraform output: save private key and environment variables:

```sh
terraform output -raw tls_private_key > ~/id_psql_test
chmod 400 ~/id_psql_test
export PRIVATE_VM_IP=$(terraform output -raw private_vm_ip)
export PUBLIC_VM_IP=$(terraform output -raw public_vm_ip)
export PRIVATE_PSQL_HOSTNAME=$(terraform output -raw private_psql_hostname)
export PUBLIC_PSQL_HOSTNAME=$(terraform output -raw public_psql_hostname)
export PSQL_ADMIN=$(terraform output -raw psql_admin_name)
```

### Perform tests

To perform tests, you have to connect to each vm with corresponding commands
- `ssh -t -i ~/id_psql_test adminuser@$PRIVATE_VM_IP PSQL_HOSTNAME=$PRIVATE_PSQL_HOSTNAME PSQL_ADMIN=$PSQL_ADMIN bash -l`
- `ssh -t -i ~/id_psql_test adminuser@$PUBLIC_VM_IP PSQL_HOSTNAME=$PUBLIC_PSQL_HOSTNAME PSQL_ADMIN=$PSQL_ADMIN bash -l`

Once you are connected to a VM run the commands:

```sh
sudo apt update && sudo apt upgrade -y && sudo apt-get install -y postgresql-client postgresql-contrib

pgbench -i "host=$PSQL_HOSTNAME.postgres.database.azure.com port=5432 dbname=exampledb user=$PSQL_ADMIN@$PSQL_HOSTNAME sslmode=require"

# 3 client, 60 seconds, run transactional commands
pgbench "host=$PSQL_HOSTNAME.postgres.database.azure.com port=5432 dbname=exampledb user=$PSQL_ADMIN@$PSQL_HOSTNAME sslmode=require" -c 3 -T 60

# 3 client, 60 seconds, select-only
pgbench "host=$PSQL_HOSTNAME.postgres.database.azure.com port=5432 dbname=exampledb user=$PSQL_ADMIN@$PSQL_HOSTNAME sslmode=require" -c 3 -T 60 -S
```

### Check results

Open Log Analytics and query:

```kusto
AzureDiagnostics 
| project TimeGenerated, Resource, Message
| where Message has "connection received: host"
| where Message !has "127.0.0.1"
| take 1000
```

TODO: Billable metric is removed. Find another way to show the traffic price :(

Open any VM resource
- open `Metrics` tab
- select `Network Out Billable`
- select both VMs as scope:

![PSQL network](../files/03-06-core-serivces/psql_network.png)

### Clean up

Remove created resources: `terraform destroy`

## AKS networking services

1. Depends on chosen AKS networking type, Azure might create differnt setup. However, most of autogenerated resoruces will be in cloud-managed resource-group `MC_{rg_name}_{aks_name}_{location}` for example `MC_rg-igork-aks_aksigork_germanywestcentral`.

2. Review Load Balancer Frontend and Backend configs, Inbound/Outbound rules

3. Check Network Security Group Inbound/Outbound rules

4. Review VNet: address space, subnets, Service Endpoints
